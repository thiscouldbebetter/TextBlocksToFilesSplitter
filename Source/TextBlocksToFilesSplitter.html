<html>
<body>

<div id="divUi">

	<h3>Text Blocks to Files Splitter</h3>

	<p>
		Paste or upload a passage of text into the
		"Text to Split into Blocks and Save as Files" box,
		specify a delimiter (usually some number of blank lines),
		and click the Split button to initiate the saving
		of each block into its own file.
	</p>
	
	<div>
		<label>Text to Split into Blocks and Save as Files:</label>
		<button onclick="buttonTextToSplitClear_Clicked()">Clear</button>
		<button onclick="buttonTextToSplitLoadDemo_Clicked()">Load Demo Text</button>
		<label>Load File:</label>
		<input type="file" onchange="inputFile_Changed(this)"></input>
		<br />
		<textarea id="textareaTextToSplit" cols="40" rows="10"></textarea>
	</div>
	
	<div>
		<label>Delimiter between Blocks:</label>
		<input id="inputBlockDelimiter" value="\n\n"></input>
	</div>

	<div>
		<label>Possible Delimiters between Block Title and Body:</label>
		<br />
		<textarea
			id="textareaTitleDelimiters"
			cols="10"
			rows="3"
		>\n</textarea>
	</div>
	
	<div>
		<label>File Name Prefix:</label>
		<input id="inputFileNamePrefix" value="Blocks_"></input>
	</div>

	<div>
		<label>Block File Names Should Be Prefixed With Number:</label>
		<input
			id="checkboxBlockFileNamesShouldBePrefixedWithNumber"
			type="checkbox"
			checked="true"
		></input>
	</div>

	<div>
		<label>Consolidate into Single TAR File:</label>
		<input
			id="checkboxConsolidateIntoSingleTarFile"
			type="checkbox"
			checked="true"
		></input>
	</div>

	<div>
		<button onclick="buttonSplit_Clicked()">
			Split Text into Blocks and Save as Files
		</button>
	</div>

</div>

<script type="text/javascript" src="TarFileExplorer/Source/TarFile/TarFile.js"></script>
<script type="text/javascript" src="TarFileExplorer/Source/TarFile/TarFileEntry.js"></script>
<script type="text/javascript" src="TarFileExplorer/Source/TarFile/TarFileEntryHeader.js"></script>
<script type="text/javascript" src="TarFileExplorer/Source/TarFile/TarFileTypeFlag.js"></script>
<script type="text/javascript" src="TarFileExplorer/Source/Utility/ByteStream.js"></script>

<script type="text/javascript">

function buttonSplit_Clicked()
{
	var d = document;
	var textareaTextToSplit =
		d.getElementById("textareaTextToSplit");
	var textToSplit = textareaTextToSplit.value;

	var inputBlockDelimiter =
		d.getElementById("inputBlockDelimiter");
	var blockDelimiter = inputBlockDelimiter.value;

	var textareaTitleDelimiters =
		d.getElementById("textareaTitleDelimiters");
	var titleDelimitersAsString = textareaTitleDelimiters.value;
	var newline = "\n";
	var titleDelimiters = titleDelimitersAsString.split(newline);

	var charPairsEscapedAndUnescaped =
	[
		[ "\\n", "\n" ],
		[ "\\r", "\r" ],
		[ "\\t", "\t" ]
	];

	for (var i = 0; i < charPairsEscapedAndUnescaped.length; i++)
	{
		var charPair =
			charPairsEscapedAndUnescaped[i];

		var charEscaped = charPair[0];
		var charUnescaped = charPair[1];

		blockDelimiter =
			blockDelimiter
				.split(charEscaped).join(charUnescaped);

		titleDelimiters =
			titleDelimiters.map
			(
				x => x.split(charEscaped).join(charUnescaped)
			);
	}

	var textBlocks = textToSplit.split(blockDelimiter);

	var inputFileNamePrefix =
		d.getElementById("inputFileNamePrefix");

	var fileNamePrefix = inputFileNamePrefix.value || "Blocks_";

	var checkboxBlockFileNamesShouldBePrefixedWithNumber =
		d.getElementById("checkboxBlockFileNamesShouldBePrefixedWithNumber");

	var blockNumberShouldBeIncludedInFileName =
		checkboxBlockFileNamesShouldBePrefixedWithNumber.checked;

	var checkboxConsolidateIntoSingleTarFile =
		d.getElementById("checkboxConsolidateIntoSingleTarFile");

	var blocksShouldBeDownloadedAsTarFileNotIndividually =
		checkboxConsolidateIntoSingleTarFile.checked;

	var textBlockFiles = TextBlockFile.fromTextBlocks
	(
		fileNamePrefix,
		titleDelimiters,
		blocksShouldBeDownloadedAsTarFileNotIndividually,
		blockNumberShouldBeIncludedInFileName,
		textBlocks
	);

	var textBlocksAsDownloadLinks =
		textBlockFiles.map(x => x.toLink() );

	// todo
	// Might need to space these out, because
	// only a certain number of files can be downloaded at once.
	textBlocksAsDownloadLinks.forEach(x => x.click() );
}

function buttonTextToSplitClear_Clicked()
{
	var d = document;
	var textareaTextToSplit =
		d.getElementById("textareaTextToSplit");
	textareaTextToSplit.value = "";
}

function buttonTextToSplitLoadDemo_Clicked()
{
	var d = document;
	var textareaTextToSplit =
		d.getElementById("textareaTextToSplit");

	var textDemoAsLines =
	[
		"This is the first block.",
		"",
		"This is the second block.",
		"It has two lines.",
		"",
		"This is the third block.",
		"It has three lines.",
		"Each block is delimited by a blank line.",
		"",
		"This is the fourth and final block."
	];
	
	var newline = "\n";
	var textDemo = textDemoAsLines.join(newline);

	textareaTextToSplit.value = textDemo;
}

function inputFile_Changed(inputFile)
{
	var file = inputFile.files[0];
	if (file != null)
	{
		var fileReader = new FileReader();
		fileReader.onload = (event) =>
		{
			var fileText = event.target.result;
			var d = document;
			var textareaTextToSplit =
				d.getElementById("textareaTextToSplit");
			textareaTextToSplit.value = fileText;
			
			var inputFileNamePrefix =
				d.getElementById("inputFileNamePrefix");
			inputFileNamePrefix.value = file.name.split(".")[0];
		};
		fileReader.readAsText(file);
	}
}

// Classes.

class StringHelper
{
	constructor()
	{
		var asciiCharAndUnicodeVariantsArray =
		[
			[ "A", "ÁÀÂĀÄ" ],
			[ "E", "ÉÈÊĒË" ],
			[ "I", "ÍÌÎĪÏ" ],
			[ "O", "ÓÒÔŌÖ" ],
			[ "U", "ÚÙÛŪÜ" ],

			[ "a", "áàâāä" ],
			[ "e", "éèêēë" ],
			[ "i", "íìîīï" ],
			[ "o", "óòôōö" ],
			[ "u", "úùûūü" ],
		];

		var asciiCharsByUnicodeVariant = new Map();

		for (var i = 0; i < asciiCharAndUnicodeVariantsArray.length; i++)
		{
			var asciiCharAndUnicodeVariants =
				asciiCharAndUnicodeVariantsArray[i];
			var asciiChar = asciiCharAndUnicodeVariants[0];
			var unicodeVariantsAsString = asciiCharAndUnicodeVariants[1];
			var unicodeVariants = unicodeVariantsAsString.split("");
			for (var v = 0; v < unicodeVariants.length; v++)
			{
				var unicodeVariant = unicodeVariants[v];
				asciiCharsByUnicodeVariant.set(unicodeVariant, asciiChar);
			}
		}

		this.asciiCharsByUnicodeVariant = asciiCharsByUnicodeVariant;
	}

	static Instance()
	{
		if (this._instance == null)
		{
			this._instance = new StringHelper();
		}
		return this._instance;
	}

	unicodeStringConvertToAscii(stringToConvert)
	{
		var stringConverted =
			stringToConvert
				.split("")
				.map
				(
					x =>
						this.asciiCharsByUnicodeVariant.has(x)
						? this.asciiCharsByUnicodeVariant.get(x)
						: x
				)
				.join("");

		var stringConvertedHasNonAsciiCharCodes =
			stringConverted.split("").some(x => x.charCodeAt(0) > 127);

		if (stringConvertedHasNonAsciiCharCodes)
		{
			throw new Error
			(
				"After conversion, string still has non-ASCII characters: "
				+ stringConverted
			);
		}

		return stringConverted;
	}
}

class TextBlockFile
{
	constructor(fileName, dataAsUrl)
	{
		this.fileName = fileName;
		this.dataAsUrl = dataAsUrl;
	}

	static fromTextBlocks
	(
		fileNamePrefix,
		titleDelimiters,
		blocksShouldBeDownloadedAsTarFileNotIndividually,
		blockNumberShouldBeIncludedInFileName,
		textBlocks
	)
	{
		var textBlockCount = textBlocks.length;
		var textBlockNumberDigitCount =
			Math.ceil(Math.log(textBlockCount) / Math.log(10) );

		var blockTitleLengthMax = 64;

		var textBlockFiles = [];

		if (blocksShouldBeDownloadedAsTarFileNotIndividually)
		{
			var tfe = ThisCouldBeBetter.TarFileExplorer;
			var TarFile = tfe.TarFile;
			var TarFileEntry = tfe.TarFileEntry;

			var textBlockFileNames = [];
			var textBlockFileNamesLookup = new Map();

			var stringHelper = StringHelper.Instance();

			for (var i = 0; i < textBlocks.length; i++)
			{
				var textBlock = textBlocks[i];

				var blockTitle = textBlock;

				if (blockTitle.length > blockTitleLengthMax)
				{
					blockTitle = blockTitle.substr(0, blockTitleLengthMax);
				}

				for (var d = 0; d < titleDelimiters.length; d++)
				{
					var titleDelimiter = titleDelimiters[d];
					var titleDelimiterWasFound = blockTitle.indexOf(titleDelimiter);
					if (titleDelimiterWasFound)
					{
						blockTitle = blockTitle.split(titleDelimiter)[0];
						break;
					}
				}

				blockTitle =
					blockTitle
						.split(" ").join("_")
						.split(".").join("")
						.split("\"").join("'");


				var blockNumberPrefix =
					blockNumberShouldBeIncludedInFileName
					? ("" + i).padStart(textBlockNumberDigitCount, "0") + "-"
					: "";
				var blockFileName =
					blockNumberPrefix + blockTitle + ".txt";
				blockFileName =
					stringHelper.unicodeStringConvertToAscii(blockFileName);

				var duplicateCount = 0;
				if (textBlockFileNamesLookup.has(blockFileName) )
				{
					var duplicateCount =
						textBlockFileNamesLookup.get(blockFileName);
					duplicateCount++;
					textBlockFileNamesLookup.set(blockFileName, duplicateCount);
					blockFileName =
						blockFileName.split(".txt")[0] + "-" + duplicateCount + ".txt";
				}
				else
				{
					textBlockFileNamesLookup.set(blockFileName, 0);
				}
				
				textBlockFileNames.push(blockFileName);
			}

			var textBlocksAsTarFileEntries =
				textBlocks.map
				(
					(textBlock, i) =>
					{
						var blockFileName = textBlockFileNames[i];
						var textBlockAsBytes =
							textBlock.split("").map(x => x.charCodeAt(0) );
						var textBlockAsTarFileEntry =
							TarFileEntry.fileNew(blockFileName, textBlockAsBytes);
						return textBlockAsTarFileEntry;
					}
				);

			var tarFileName = fileNamePrefix + ".tar";

			var textBlocksAsTarFile = new TarFile
			(
				tarFileName,
				textBlocksAsTarFileEntries
			);

			var tarFileAsBytes = textBlocksAsTarFile.toBytes();
			var tarFileAsArrayBuffer = new ArrayBuffer(tarFileAsBytes.length);
			var tarFileAsUIntArray = new Uint8Array(tarFileAsArrayBuffer);
			for (var i = 0; i < tarFileAsBytes.length; i++)
			{
				tarFileAsUIntArray[i] = tarFileAsBytes[i];
			}
			var tarFileAsBlob = new Blob
			(
				[ tarFileAsArrayBuffer ],
				{ type:"application/x-tar" }
			);

			var tarFileAsUrl =
				window.URL.createObjectURL(tarFileAsBlob);

			var tarFileAsTextBlockFile =
				new TextBlockFile(tarFileName, tarFileAsUrl);

			textBlockFiles.push(tarFileAsTextBlockFile);
		}
		else
		{
			for (var i = 0; i < textBlocks.length; i++)
			{
				var textBlock = textBlocks[i];
				var textBlockAsBlob =
					new Blob( [textBlock], { type: "text/plain" });
				var textBlockAsUrl =
					window.URL.createObjectURL(textBlockAsBlob);

				var textBlockTitle = textBlock.split(titleDelimiter)[0];
				textBlockTitle =
					textBlockTitle
						.split(" ").join("_")
						.split(".").join("");
				var blockNumberPrefix =
					blockNumberShouldBeIncludedInFileName
					? ("" + i).padStart(textBlockNumberDigitCount, "0") + "-"
					: "";
				var textBlockFileName =
					blockNumberPrefix + textBlockTitle + ".txt";

				var textBlockFile =
					new TextBlockFile(textBlockFileName, textBlockAsUrl);

				textBlockFiles.push(textBlockFile);
			}
		}

		return textBlockFiles;
	}

	toLink()
	{
		var link = document.createElement("a");
		link.download = this.fileName;
		link.href = this.dataAsUrl;
		return link;
	}
}

</script>

</body>
</html>